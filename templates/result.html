<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Результаты Проверки Погоды</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #eef2f3;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
        }
        .result-container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 800px;
        }
        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333333;
        }
        .city-section {
            margin-bottom: 20px;
        }
        .city-section h3 {
            margin-bottom: 10px;
            color: #555555;
        }
        .city-section p {
            margin: 5px 0;
            color: #333333;
        }
        .status {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .back-button, .graphs-button {
            display: inline-block;
            padding: 12px 20px;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #eee;
        }
        .buttons-container {
            text-align: center;
            margin-top: 30px;
        }

        #mapid {
            width: 100%;
            height: 400px;
            margin-top: 30px;
            border: 1px solid #ccc;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     crossorigin=""></script>
</head>
<body>
    <div class="result-container">
        <h2>Результаты Проверки Погоды</h2>

        {% if not is_new_forecast %}
        <div class="city-section">
            <h3>Начальная точка: {{ start_city }}</h3>
            {% if temperature_start is not none %}
            <p><strong>Температура:</strong> {{ temperature_start }}°C</p>
            <p><strong>Скорость ветра:</strong> {{ wind_speed_start }} км/ч</p>
            <p><strong>Вероятность осадков:</strong> {{ precip_prob_start }}%</p>
            <div class="status">
                <strong>Оценка погодных условий:</strong> {{ weather_status_start }}
            </div>
            {% endif %}
        </div>

        <div class="city-section">
            <h3>Конечная точка: {{ end_city }}</h3>
            {% if temperature_end is not none %}
            <p><strong>Температура:</strong> {{ temperature_end }}°C</p>
            <p><strong>Скорость ветра:</strong> {{ wind_speed_end }} км/ч</p>
            <p><strong>Вероятность осадков:</strong> {{ precip_prob_end }}%</p>
            <div class="status">
                <strong>Оценка погодных условий:</strong> {{ weather_status_end }}
            </div>
            {% endif %}
        </div>
        {% else %}
        <h2>Прогноз на {{ days }} {{ days == 1 and 'день' or 'дней' }}</h2>
        {% for point in forecasts %}
        <div class="city-section">
            <h3>{{ point.city }}</h3>
            {% if point.forecast and point.forecast|length > 0 %}
            <table>
                <tr>
                    <th>Дата</th>
                    <th>Мин. Темп.</th>
                    <th>Макс. Темп.</th>
                    <th>Скорость ветра (км/ч)</th>
                    <th>Вероятность осадков (%)</th>
                    <th>Днём</th>
                    <th>Ночью</th>
                </tr>
                {% for f in point.forecast %}
                <tr>
                    <td>{{ f.date }}</td>
                    <td>{{ f.min_temp }}°C</td>
                    <td>{{ f.max_temp }}°C</td>
                    <td>{{ f.wind_speed }}</td>
                    <td>{{ f.precip_prob }}</td>
                    <td>{{ f.weather_text_day }}</td>
                    <td>{{ f.weather_text_night }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p>Нет многодневных прогнозов для этой точки.</p>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}

        {% if forecasts and forecasts|length > 0 %}
        <div id="mapid"></div>
        <script>
            var points = {{ forecasts|tojson }};

            var map = L.map('mapid').setView([55.751244, 37.618423], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
            }).addTo(map);

            var markers = [];
            points.forEach(function(p) {
                if (p.lat && p.lon) {
                    var popupHtml = '<h3>' + p.city + '</h3>';
                    if (p.forecast && p.forecast.length > 0) {
                        popupHtml += '<table style="border-collapse:collapse;width:100%;border:1px solid #ccc;">'
                        popupHtml += '<tr><th>Дата</th><th>Мин</th><th>Макс</th><th>Осадки</th></tr>';
                        p.forecast.forEach(function(f) {
                            popupHtml += '<tr>'
                                + '<td>' + f.date + '</td>'
                                + '<td>' + f.min_temp + '°C</td>'
                                + '<td>' + f.max_temp + '°C</td>'
                                + '<td>' + f.precip_prob + '%</td>'
                                + '</tr>';
                        });
                        popupHtml += '</table>';
                    } else {
                        popupHtml += '<p>Нет расширенного прогноза</p>';
                    }

                    var m = L.marker([p.lat, p.lon]).addTo(map).bindPopup(popupHtml);
                    markers.push(m);
                }
            });

            // Строим линию по маршруту
            var latlngs = [];
            points.forEach(function(p) {
                if (p.lat && p.lon) {
                    latlngs.push([p.lat, p.lon]);
                }
            });
            if (latlngs.length > 1) {
                var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);
                var group = L.featureGroup(markers);
                group.addLayer(polyline);
                map.fitBounds(group.getBounds(), {padding: [50,50]});
            } else if (markers.length > 0) {
                var group = L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {padding: [50,50]});
            }
        </script>
        {% endif %}

        <div class="buttons-container">
            <a href="{{ url_for('home') }}" class="back-button">Вернуться к форме</a>
            {% if is_new_forecast %}
            <a href="/dash_app" class="graphs-button" style="margin-left:20px;">Посмотреть графики</a>
            {% endif %}
        </div>
    </div>
</body>
</html>
